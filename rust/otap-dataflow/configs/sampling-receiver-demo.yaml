settings:
  default_pipeline_ctrl_msg_channel_size: 100
  default_node_ctrl_msg_channel_size: 100
  default_pdata_channel_size: 100

nodes:
  # Sampling receiver node
  sampling_receiver:
    kind: receiver
    plugin_urn: "urn:otel:otap:sampling:receiver"
    out_ports:
      out_port:
        destinations:
          - debug_processor
        dispatch_strategy: round_robin
    config:
      # Base directory containing parquet files generated by exporter
      base_uri: "file:///home/jmacd/src/otel/otel-arrow-tail-sampler/rust/otap-dataflow/output_parquet_files"
      # Signal types to process
      signal_types: ["logs"]
      
      # Temporal processing configuration - optimized for testing existing data
      temporal:
        window_granularity: "30s"       # Smaller windows for quicker processing
        processing_delay: "1s"          # Short delay since data is static
        max_clock_drift: "1s"           # Minimal clock drift for testing
        max_file_duration: "5m"         # Allow for larger time spans in test files
      
      # Query that ensures every sampled log has at least one attribute using UNION ALL approach
      # This guarantees every log gets a sampling.adjusted_count attribute regardless of existing attributes
      query: |
        WITH filtered_logs AS (
          SELECT l.id, l._part_id
          FROM logs l
          WHERE l.time_unix_nano >= to_timestamp_nanos({window_start_ns})
            AND l.time_unix_nano < to_timestamp_nanos({window_end_ns})
        ),
        original_attrs AS (
          SELECT 
            la.parent_id,
            la.key,
            la.type,
            la.str,
            la.int,
            la.double,
            la.bool,
            la.bytes,
            la.ser as array_val,
            la._part_id
          FROM log_attrs la
          JOIN filtered_logs fl ON la.parent_id = fl.id AND la._part_id = fl._part_id
        ),
        synthetic_attrs AS (
          SELECT 
            fl.id as parent_id,
            'sampling.adjusted_count' as key,
            CAST(1 as tinyint unsigned) as type,
            '1.0' as str,
            NULL as int,
            NULL as double,
            NULL as bool,
            NULL as bytes,
            NULL as array_val,
            fl._part_id
          FROM filtered_logs fl
        )
        SELECT * FROM original_attrs
        UNION ALL
        SELECT * FROM synthetic_attrs
        ORDER BY _part_id, parent_id, key
        LIMIT 100
      
      # Performance tuning - conservative settings for testing
      performance:
        batch_size: 100
        enable_arrow_optimization: true
        memory_limit: "512MB"
        max_concurrent_files: 5
        target_partitions: 2
  
  # Debug processor to show the reconstructed data
  debug_processor:
    kind: processor
    plugin_urn: "urn:otel:debug:processor"
    out_ports:
      out_port:
        destinations:
          - noop_exporter
        dispatch_strategy: round_robin
    config:
      verbosity: detailed

  # NoOp exporter to act as a sink
  noop_exporter:
    kind: exporter
    plugin_urn: "urn:otel:noop:exporter"
    config: {}